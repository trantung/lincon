<?php
class ApiController extends BaseController {

	public function search ($mode = 'near')
	{
		// Prepare params
		$page = (int)Input::get('page', 1);
		$terminal = Input::get('terminal');
		if (!in_array($terminal, ['pc', 'sp'])) {
			$terminal = 'sp';
		}
		$options = Input::get('option', []);
        $options = array_map(function($opt) {
            return (int)$opt;
        }, $options);
		// Choose how to search
		$modal = new Office();
		$query = null;
		$r = 1;
		if ($mode == 'area') {
			$area = Input::get('pref_l') . Input::get('city_l');
			$area = \limit_string($area, 40);
			if (empty($area)) {
				return $this->json(['error' => 'Missing params']);
			}
			$query = $modal->searchQuery($area, $options);
		} elseif ($mode == 'near') {
			$lat = (double) Input::get('lat');
			$lng = (double) Input::get('lng');
			$zoom = (int)Input::get('zoom') ?: 14;
			$r = Office::$NEIGHBOURS = 5 / pow(1.4, $zoom);
			if (empty($lat) || empty($lng)) {
				return $this->json(['error' => 'Missing params']);
			}
			$query = $modal->nearbyQuery($lat, $lng, $options);
		}
		$result = $modal->buildResult($query, $page, $terminal);
		return $this->json(compact('result', 'area', 'options'), Input::has('jsonp'));
	}

	public function detail($id) {
		$data = (new Office())->detail($id);
		if ($data) {
		    unset($data['geo']);
			$data['part'] = Office::section($data['h_type']);
			$data['color'] = Office::coloring($data['h_type']);
		} else {
			$data = [
				"id"			=> null,
				"business_id"	=> null,
				"latitude"		=> null,
				"longitude"		=> null,
				"servicecd"		=> null,
				"item6"			=> null,
				"item7"			=> null,
				"item9"			=> null,
				"item10"		=> null,
				"item20"		=> "-",
				"item21"		=> null,
				"item22"		=> null,
				"item23"		=> null,
				"item27"		=> null,
				"item28"		=> null,
				"item29"		=> null,
				"item30"		=> null,
				"item31"		=> null,
				"item32"		=> null,
				"item33"		=> null,
				"item34"		=> null,
				"item36"		=> null,
				"item38"		=> null,
				"item42"		=> null,
				"item43"		=> null,
				"item44"		=> null,
				"item51"		=> null,
				"item52"		=> null,
				"item53"		=> null,
				"item54"		=> null,
				"item55"		=> null,
				"item56"		=> null,
				"item57"		=> null,
				"item58"		=> null,
				"item59"		=> null,
				"item60"		=> null,
				"item61"		=> null,
				"item62"		=> null,
				"item63"		=> null,
				"item64"		=> null,
				"item155"		=> null,
				"item156"		=> null,
				"item157"		=> null,
				"item360"		=> null,
				"item361"		=> null,
				"item363"		=> null,
				"item371"		=> null,
				"item381"		=> null,
				"item386"		=> null,
				"item707"		=> null,
				"item708"		=> null,
				"item709"		=> null,
				"item710"		=> null,
				"item713"		=> null,
				"item714"		=> null,
				"item715"		=> null,
				"item716"		=> null,
				"item717"		=> null,
				"item718"		=> null,
				"item719"		=> null,
				"item720"		=> null,
				"item721"		=> null,
				"item722"		=> null,
				"item723"		=> null,
				"item724"		=> null,
				"item725"		=> null,
				"item726"		=> null,
				"item730"		=> null,
				"item780"		=> null,
				"item781"		=> null,
				"item791"		=> null,
				"item822"		=> null,
				"item825"		=> null,
				"item854"		=> null,
				"item856"		=> null,
				"item884"		=> null,
				"item885"		=> null,
				"item1002"		=> null,
				"item1005"		=> null,
				"item1011"		=> null,
				"item1018"		=> null,
				"item1027"		=> null,
				"item1057"		=> null,
				"item1060"		=> null,
				"item1064"		=> null,
				"item1065"		=> null,
				"item1094"		=> null,
				"item1095"		=> null,
				"item1096"		=> null,
				"item1097"		=> null,
				"item1098"		=> null,
				"item1099"		=> null,
				"item1100"		=> null,
				"item1101"		=> null,
				"item1102"		=> null,
				"item1103"		=> null,
				"item1104"		=> null,
				"item1105"		=> null,
				"item1106"		=> null,
				"item1107"		=> null,
				"item1108"		=> null,
				"item1109"		=> null,
				"item1110"		=> null,
				"item1111"		=> null,
				"item1112"		=> null,
				"item1113"		=> null,
				"item1114"		=> null,
				"item1115"		=> null,
				"item1116"		=> null,
				"item1117"		=> null,
				"item1118"		=> null,
				"item1119"		=> null,
				"item1120"		=> null,
				"item1121"		=> null,
				"item1122"		=> null,
				"item1123"		=> null,
				"item1124"		=> null,
				"item1125"		=> null,
				"item1126"		=> null,
				"item1127"		=> null,
				"item1137"		=> null,
				"item1138"		=> null,
				"item1242"		=> null,
				"item1244"		=> null,
				"item1245"		=> null,
				"item1247"		=> null,
				"item1251"		=> null,
				"item1256"		=> null,
				"item1257"		=> null,
				"item1258"		=> null,
				"item1259"		=> null,
				"item1260"		=> null,
				"item1261"		=> null,
				"item1262"		=> null,
				"item1263"		=> null,
				"item1264"		=> null,
				"item1265"		=> null,
				"item1266"		=> null,
				"item1267"		=> null,
				"item1268"		=> null,
				"item1292"		=> null,
				"item1293"		=> null,
				"item1294"		=> null,
				"item1295"		=> null,
				"item1296"		=> null,
				"item1297"		=> null,
				"item1299"		=> null,
				"item1300"		=> null,
				"item1301"		=> null,
				"item1303"		=> null,
				"item1304"		=> null,
				"item1305"		=> null,
				"item1307"		=> null,
				"item1308"		=> null,
				"item1309"		=> null,
				"item1314"		=> null,
				"item1315"		=> null,
				"item1316"		=> null,
				"item1317"		=> null,
				"item1319"		=> null,
				"item1320"		=> null,
				"item1321"		=> null,
				"item1322"		=> null,
				"item1323"		=> null,
				"item1325"		=> null,
				"item1326"		=> null,
				"item1327"		=> null,
				"item1328"		=> null,
				"item1329"		=> null,
				"item1331"		=> null,
				"item1364"		=> null,
				"item1337"		=> null,
				"item1408"		=> null,
				"item1410"		=> null,
				"item1411"		=> null,
				"item1412"		=> null,
				"item1414"		=> null,
				"item1415"		=> null,
				"item1421"		=> null,
				"item1423"		=> null,
				"item1424"		=> null,
				"item1425"		=> null,
				"item1439"		=> null,
				"item1440"		=> null,
				"item1442"		=> null,
				"item1443"		=> null,
				"item1445"		=> null,
				"item1446"		=> null,
				"item1452"		=> null,
				"item1453"		=> null,
				"item1454"		=> null,
				"item1456"		=> null,
				"item1458"		=> null,
				"item1462"		=> null,
				"item1464"		=> null,
				"item1465"		=> null,
				"item1466"		=> null,
				"item1468"		=> null,
				"item1469"		=> null,
				"item1483"		=> null,
				"item1484"		=> null,
				"item1486"		=> null,
				"item1487"		=> null,
				"item1489"		=> null,
				"item1490"		=> null,
				"item1496"		=> null,
				"item1497"		=> null,
				"item1498"		=> null,
				"item1500"		=> null,
				"item1502"		=> null,
				"item1506"		=> null,
				"item1507"		=> null,
				"item1508"		=> null,
				"item1509"		=> null,
				"item1510"		=> null,
				"item1511"		=> null,
				"item1512"		=> null,
				"item1513"		=> null,
				"item1514"		=> null,
				"item1515"		=> null,
				"item1516"		=> null,
				"item1518"		=> null,
				"item1519"		=> null,
				"item1520"		=> null,
				"item1521"		=> null,
				"item1522"		=> null,
				"item1523"		=> null,
				"item1524"		=> null,
				"item1525"		=> null,
				"item1526"		=> null,
				"item1527"		=> null,
				"item1528"		=> null,
				"del_flag"		=> null,
				"address"		=> "-",
				"registered_no"	=> null,
				"lat"			=> "0",
				"lng"			=> "0",
				"h_type"		=> null,
				"week"			=> false,
				"sat"			=> false,
				"sun"			=> false,
				"holiday"		=> null,
				"scheduled"		=> null,
				"tel"			=> null,
				"fax"			=> null,
				"name"			=> "該当する施設はございません。",
				"area_1"		=> null,
				"area_2"		=> null,
				"started"		=> null,
				"created"		=> null,
				"color"			=> [
					"color"		=> null,
					"group"		=> "-",
					"type"		=> "-",
				],
				'part'			=> null,
				'color'			=> null,
			];
		}
		return $this->json($data);
	}
}
